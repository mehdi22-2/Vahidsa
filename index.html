<!doctype html>
<html lang="fa" dir="rtl" style="height: 100%;">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±ÙˆØ´ Ø¯Ø§Ø±Ùˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Vazirmatn', sans-serif;
      margin: 0;
      padding: 0;
      height: 100%;
      font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    * {
      box-sizing: border-box;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .input-focus:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }
    .badge-prescribed { background: #10b981; color: white; }
    .badge-rejected { background: #ef4444; color: white; }
    .badge-followup { background: #f59e0b; color: white; }
    .section-tab {
      padding: 8px 4px;
      background: white;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-weight: 700;
      font-size: 10px;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      flex: 1;
      text-align: center;
      min-width: 0;
    }
    .section-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-color: #4c51bf;
    }
    .section-tab .icon {
      font-size: 14px;
      display: block;
      margin-bottom: 2px;
    }
    .floating-btn {
      position: fixed;
      bottom: 16px;
      left: 16px;
      z-index: 40;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      font-size: 24px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body style="height: 100%; overflow-x: hidden;">
  <div style="min-height: 100%; display: flex; flex-direction: column; background: #f0f4f8;"><!-- Header -->
   <header class="gradient-bg text-white shadow-xl">
    <div class="px-4 py-3">
     <div class="text-center mb-2">
      <h1 class="text-lg font-bold mb-1">ğŸ’Š Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±ÙˆØ´</h1>
      <p class="text-xs opacity-90">âš¡ ÙˆØ­ÛŒØ¯ Ø³Ù„ÛŒÙ…ÛŒ</p>
     </div>
     <div class="grid grid-cols-4 gap-1 text-xs">
      <div class="text-center bg-white bg-opacity-20 rounded-lg px-2 py-1.5">
       <div class="text-base font-bold" id="totalDoctors">
        0
       </div>
       <div class="text-xs opacity-90">
        Ù¾Ø²Ø´Ú©Ø§Ù†
       </div>
      </div>
      <div class="text-center bg-white bg-opacity-20 rounded-lg px-2 py-1.5">
       <div class="text-base font-bold" id="totalPharmacies">
        0
       </div>
       <div class="text-xs opacity-90">
        Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡
       </div>
      </div>
      <div class="text-center bg-white bg-opacity-20 rounded-lg px-2 py-1.5">
       <div class="text-base font-bold" id="totalVisits">
        0
       </div>
       <div class="text-xs opacity-90">
        ÙˆÛŒØ²ÛŒØª
       </div>
      </div>
      <div class="text-center bg-white bg-opacity-20 rounded-lg px-2 py-1.5">
       <div class="text-base font-bold" id="totalOrders">
        0
       </div>
       <div class="text-xs opacity-90">
        Ø³ÙØ§Ø±Ø´
       </div>
      </div>
     </div>
    </div>
   </header><!-- Section Tabs -->
   <div class="px-1 pt-2">
    <div class="flex gap-0.5 overflow-x-auto"><button class="section-tab active" data-section="doctors"> <span class="icon">ğŸ‘¨â€âš•ï¸</span> <span>Ù¾Ø²Ø´Ú©Ø§Ù†</span> </button> <button class="section-tab" data-section="visits"> <span class="icon">ğŸ“‹</span> <span>ÙˆÛŒØ²ÛŒØª</span> </button> <button class="section-tab" data-section="pharmacies"> <span class="icon">ğŸ¥</span> <span>Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</span> </button> <button class="section-tab" data-section="orders"> <span class="icon">ğŸ“¦</span> <span>Ø³ÙØ§Ø±Ø´</span> </button> <button class="section-tab" data-section="sales"> <span class="icon">ğŸ“Š</span> <span>ÙØ±ÙˆØ´</span> </button> <button class="section-tab" data-section="reports"> <span class="icon">ğŸ“„</span> <span>Ú¯Ø²Ø§Ø±Ø´</span> </button>
    </div>
   </div><!-- Main Content -->
   <main class="flex-1 px-2 pb-20 overflow-y-auto"><!-- Doctors Section -->
    <div id="doctorsSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3">
     <div class="mb-3"><input type="text" id="searchDoctorInput" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ..." class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div id="doctorsList" class="space-y-2"></div>
     <div id="emptyDoctorsState" class="text-center py-10 hidden">
      <div class="text-5xl mb-3">
       ğŸ‘¨â€âš•ï¸
      </div>
      <h3 class="text-base font-bold text-gray-700 mb-2">Ù‡Ù†ÙˆØ² Ù¾Ø²Ø´Ú©ÛŒ Ø«Ø¨Øª ï¿½ï¿½Ø´Ø¯Ù‡</h3>
      <p class="text-gray-500 text-xs">Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ + Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
     </div>
    </div><!-- Visits Section -->
    <div id="visitsSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3 hidden">
     <div class="mb-3"><input type="text" id="searchVisitInput" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ..." class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div id="visitsList" class="space-y-2"></div>
     <div id="emptyVisitsState" class="text-center py-10 hidden">
      <div class="text-5xl mb-3">
       ğŸ“‹
      </div>
      <h3 class="text-base font-bold text-gray-700 mb-2">Ù‡Ù†ÙˆØ² ÙˆÛŒØ²ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3>
      <p class="text-gray-500 text-xs">Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ + Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
     </div>
    </div><!-- Pharmacies Section -->
    <div id="pharmaciesSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3 hidden">
     <div class="mb-3"><input type="text" id="searchPharmacyInput" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ..." class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div id="pharmaciesList" class="space-y-2"></div>
     <div id="emptyPharmaciesState" class="text-center py-10 hidden">
      <div class="text-5xl mb-3">
       ğŸ¥
      </div>
      <h3 class="text-base font-bold text-gray-700 mb-2">Ù‡Ù†ÙˆØ² Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3>
      <p class="text-gray-500 text-xs">Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ + Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
     </div>
    </div><!-- Orders Section -->
    <div id="ordersSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3 hidden">
     <div class="mb-3"><input type="text" id="searchOrderInput" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ..." class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div id="ordersList" class="space-y-2"></div>
     <div id="emptyOrdersState" class="text-center py-10 hidden">
      <div class="text-5xl mb-3">
       ğŸ“¦
      </div>
      <h3 class="text-base font-bold text-gray-700 mb-2">Ù‡Ù†ÙˆØ² Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3>
      <p class="text-gray-500 text-xs">Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ + Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
     </div>
    </div><!-- Sales Section -->
    <div id="salesSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3 hidden">
     <div class="mb-3"><button id="addSalesBtn" class="w-full gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow text-sm"> â• Ø«Ø¨Øª Ø¢Ù…Ø§Ø± ÙØ±ÙˆØ´ Ù‡ÙØªÚ¯ÛŒ </button>
     </div>
     <div class="bg-white rounded-lg shadow p-3 mb-3">
      <canvas id="salesChart" style="max-height: 250px;"></canvas>
     </div>
     <div id="salesList" class="space-y-2"></div>
     <div id="emptySalesState" class="text-center py-10 hidden">
      <div class="text-5xl mb-3">
       ğŸ“Š
      </div>
      <h3 class="text-base font-bold text-gray-700 mb-2">Ù‡Ù†ÙˆØ² Ø¢Ù…Ø§Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3>
      <p class="text-gray-500 text-xs">Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
     </div>
    </div><!-- Reports Section -->
    <div id="reportsSection" class="bg-white rounded-b-xl rounded-tr-xl shadow-lg p-3 hidden">
     <div class="space-y-3">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-3 border-2 border-blue-200">
       <h3 class="font-bold text-sm mb-2 text-blue-900">ğŸ“„ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø±Ø§Ø¦Ù‡</h3>
       <div class="space-y-2"><select id="reportType" class="input-focus w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-xs"> <option value="doctors">Ù¾Ø²Ø´Ú©Ø§Ù†</option> <option value="pharmacies">Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡â€ŒÙ‡Ø§</option> <option value="both">Ù‡Ø± Ø¯Ùˆ</option> </select> <select id="reportPeriod" class="input-focus w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-xs"> <option value="weekly">Ù‡ÙØªÚ¯ÛŒ</option> <option value="monthly">Ù…Ø§Ù‡Ø§Ù†Ù‡</option> <option value="custom">Ø³ÙØ§Ø±Ø´ÛŒ</option> </select>
        <div class="grid grid-cols-2 gap-2"><input type="date" id="reportFromDate" class="input-focus w-full px-2 py-2 border-2 border-gray-300 rounded text-xs"> <input type="date" id="reportToDate" class="input-focus w-full px-2 py-2 border-2 border-gray-300 rounded text-xs">
        </div><button id="generatePDFBtn" class="w-full bg-red-600 text-white px-4 py-2.5 rounded-lg font-bold text-xs shadow"> ğŸ“‘ ØªÙˆÙ„ÛŒØ¯ PDF </button>
       </div>
      </div>
     </div>
    </div><!-- Floating Button --> <button id="floatingBtn" class="floating-btn gradient-bg text-white">â•</button>
   </main><!-- Footer -->
   <footer class="bg-white border-t border-gray-200 py-2 text-center">
    <p class="text-xs font-semibold text-gray-600">Â© 2024 | <span class="text-indigo-600">â­ ÙˆØ­ÛŒØ¯ Ø³Ù„ÛŒÙ…ÛŒ</span></p>
   </footer>
  </div><!-- Doctor Modal -->
  <div id="doctorModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-end z-50" style="display: none;">
   <div class="bg-white w-full h-full overflow-y-auto fade-in">
    <div class="gradient-bg text-white p-4 sticky top-0 z-10 flex items-center justify-between">
     <h2 id="doctorModalTitle" class="text-base font-bold">â• Ø«Ø¨Øª Ù¾Ø²Ø´Ú©</h2><button id="closeDoctorModal" class="text-xl">âœ–ï¸</button>
    </div>
    <form id="doctorForm" class="p-4 space-y-3">
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</label> <input type="text" id="doctorNameInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ®ØµØµ *</label> <input type="text" id="specialtyInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ *</label> <input type="tel" id="phoneInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù…Ù†Ø·Ù‚ï¿½ï¿½ *</label> <input type="text" id="areaInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø¢Ø¯Ø±Ø³</label> <input type="text" id="addressInput" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div class="flex gap-2 pt-4"><button type="submit" class="flex-1 gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow-lg text-sm">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button> <button type="button" id="cancelDoctorBtn" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-bold text-sm">âœ–ï¸</button>
     </div>
    </form>
   </div>
  </div><!-- Visit Modal -->
  <div id="visitModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-end z-50" style="display: none;">
   <div class="bg-white w-full h-full overflow-y-auto fade-in">
    <div class="gradient-bg text-white p-4 sticky top-0 z-10 flex items-center justify-between">
     <h2 id="visitModalTitle" class="text-base font-bold">â• Ø«Ø¨Øª ÙˆÛŒØ²ÛŒØª</h2><button id="closeVisitModal" class="text-xl">âœ–ï¸</button>
    </div>
    <form id="visitForm" class="p-4 space-y-3">
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø²Ø´Ú© *</label> <select id="doctorSelect" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"> <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option> </select>
     </div>
     <div class="grid grid-cols-2 gap-2">
      <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ§Ø±ÛŒØ® *</label> <input type="date" id="visitDate" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
      </div>
      <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø³Ø§Ø¹Øª *</label> <input type="time" id="visitTime" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
      </div>
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù†ØªÛŒØ¬Ù‡ *</label> <select id="visitResult" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"> <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option> <option value="prescribed">Ø³ÙØ§Ø±Ø´ Ø´Ø¯Ù‡</option> <option value="rejected">Ø±Ø¯ Ø´Ø¯Ù‡</option> <option value="followup">ÙˆÛŒØ²ÛŒØª Ù…Ø¬Ø¯Ø¯</option> </select>
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label> <textarea id="visitNotes" rows="2" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"></textarea>
     </div>
     <div class="flex gap-2 pt-4"><button type="submit" class="flex-1 gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow-lg text-sm">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button> <button type="button" id="cancelVisitBtn" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-bold text-sm">âœ–ï¸</button>
     </div>
    </form>
   </div>
  </div><!-- Pharmacy Modal -->
  <div id="pharmacyModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-end z-50" style="display: none;">
   <div class="bg-white w-full h-full overflow-y-auto fade-in">
    <div class="gradient-bg text-white p-4 sticky top-0 z-10 flex items-center justify-between">
     <h2 id="pharmacyModalTitle" class="text-base font-bold">â• Ø«Ø¨Øª Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</h2><button id="closePharmacyModal" class="text-xl">âœ–ï¸</button>
    </div>
    <form id="pharmacyForm" class="p-4 space-y-3">
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù†Ø§Ù… Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ *</label> <input type="text" id="pharmacyNameInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù†Ø§Ù… Ø¯Ø§Ø±ÙˆØ³Ø§Ø² *</label> <input type="text" id="pharmacistNameInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ *</label> <input type="tel" id="pharmacyPhoneInput" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø¢Ø¯Ø±Ø³ *</label> <textarea id="pharmacyAddressInput" required rows="2" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"></textarea>
     </div>
     <div class="flex gap-2 pt-4"><button type="submit" class="flex-1 gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow-lg text-sm">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button> <button type="button" id="cancelPharmacyBtn" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-bold text-sm">âœ–ï¸</button>
     </div>
    </form>
   </div>
  </div><!-- Order Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-end z-50" style="display: none;">
   <div class="bg-white w-full h-full overflow-y-auto fade-in">
    <div class="gradient-bg text-white p-4 sticky top-0 z-10 flex items-center justify-between">
     <h2 id="orderModalTitle" class="text-base font-bold">â• Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</h2><button id="closeOrderModal" class="text-xl">âœ–ï¸</button>
    </div>
    <form id="orderForm" class="p-4 space-y-3">
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ *</label> <select id="pharmacySelect" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"> <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option> </select>
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ§Ø±ÛŒØ® Ø³ÙØ§Ø±Ø´ *</label> <input type="date" id="orderDate" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù†Ø§Ù… Ø¯Ø§Ø±Ùˆ *</label> <input type="text" id="drugName" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div class="grid grid-cols-2 gap-2">
      <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±ØªÙ†</label> <input type="number" id="cartonQty" min="0" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
      </div>
      <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ¹Ø¯Ø§Ø¯ Ø¹Ø¯Ø¯</label> <input type="number" id="unitQty" min="0" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
      </div>
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label> <textarea id="orderNotes" rows="2" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"></textarea>
     </div>
     <div class="flex gap-2 pt-4"><button type="submit" class="flex-1 gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow-lg text-sm">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button> <button type="button" id="cancelOrderBtn" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-bold text-sm">âœ–ï¸</button>
     </div>
    </form>
   </div>
  </div><!-- Sales Modal -->
  <div id="salesModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-end z-50" style="display: none;">
   <div class="bg-white w-full h-full overflow-y-auto fade-in">
    <div class="gradient-bg text-white p-4 sticky top-0 z-10 flex items-center justify-between">
     <h2 id="salesModalTitle" class="text-base font-bold">â• Ø«Ø¨Øª Ø¢Ù…Ø§Ø± ÙØ±ÙˆØ´</h2><button id="closeSalesModal" class="text-xl">âœ–ï¸</button>
    </div>
    <form id="salesForm" class="p-4 space-y-3">
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">Ù‡ÙØªÙ‡ *</label> <input type="week" id="salesWeek" required class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ØªØ¹Ø¯Ø§Ø¯ ÙØ±ÙˆØ´ *</label> <input type="number" id="salesAmount" required min="0" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm">
     </div>
     <div><label class="block text-gray-700 font-semibold mb-1.5 text-xs">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label> <textarea id="salesNotes" rows="2" class="input-focus w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm"></textarea>
     </div>
     <div class="flex gap-2 pt-4"><button type="submit" class="flex-1 gradient-bg text-white px-4 py-3 rounded-lg font-bold shadow-lg text-sm">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button> <button type="button" id="cancelSalesBtn" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-bold text-sm">âœ–ï¸</button>
     </div>
    </form>
   </div>
  </div>
  <script>
    const STORAGE_KEYS = {
      DOCTORS: 'pharma_doctors',
      VISITS: 'pharma_visits',
      PHARMACIES: 'pharma_pharmacies',
      ORDERS: 'pharma_orders',
      SALES: 'pharma_sales'
    };

    let doctors = [];
    let visits = [];
    let pharmacies = [];
    let orders = [];
    let sales = [];
    let currentSection = 'doctors';
    let editingId = null;
    let salesChart = null;

    function loadData() {
      try {
        doctors = JSON.parse(localStorage.getItem(STORAGE_KEYS.DOCTORS)) || [];
        visits = JSON.parse(localStorage.getItem(STORAGE_KEYS.VISITS)) || [];
        pharmacies = JSON.parse(localStorage.getItem(STORAGE_KEYS.PHARMACIES)) || [];
        orders = JSON.parse(localStorage.getItem(STORAGE_KEYS.ORDERS)) || [];
        sales = JSON.parse(localStorage.getItem(STORAGE_KEYS.SALES)) || [];
        
        renderAll();
        updateStats();
        renderSalesChart();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function saveData(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (error) {
        showToast('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡', 'error');
      }
    }

    function renderAll() {
      renderDoctors();
      renderVisits();
      renderPharmacies();
      renderOrders();
      renderSales();
      populateSelects();
    }

    function updateStats() {
      document.getElementById('totalDoctors').textContent = doctors.length;
      document.getElementById('totalPharmacies').textContent = pharmacies.length;
      document.getElementById('totalVisits').textContent = visits.length;
      document.getElementById('totalOrders').textContent = orders.length;
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('fa-IR');
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('fa-IR').format(num);
    }

    // Section Switching
    document.querySelectorAll('.section-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const section = tab.dataset.section;
        currentSection = section;
        
        document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        ['doctors', 'visits', 'pharmacies', 'orders', 'sales', 'reports'].forEach(s => {
          document.getElementById(s + 'Section').classList.add('hidden');
        });
        document.getElementById(section + 'Section').classList.remove('hidden');
      });
    });

    // Floating Button
    document.getElementById('floatingBtn').addEventListener('click', () => {
      editingId = null;
      if (currentSection === 'doctors') {
        document.getElementById('doctorModal').style.display = 'flex';
      } else if (currentSection === 'visits') {
        if (doctors.length === 0) {
          showToast('âŒ Ø§Ø¨ØªØ¯Ø§ Ù¾Ø²Ø´Ú© Ø«Ø¨Øª Ú©Ù†ÛŒØ¯', 'error');
          return;
        }
        document.getElementById('visitModal').style.display = 'flex';
      } else if (currentSection === 'pharmacies') {
        document.getElementById('pharmacyModal').style.display = 'flex';
      } else if (currentSection === 'orders') {
        if (pharmacies.length === 0) {
          showToast('âŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯', 'error');
          return;
        }
        document.getElementById('orderModal').style.display = 'flex';
      }
    });

    // Render Doctors
    function renderDoctors() {
      const container = document.getElementById('doctorsList');
      const empty = document.getElementById('emptyDoctorsState');
      const searchTerm = document.getElementById('searchDoctorInput').value.toLowerCase();
      
      let filtered = doctors.filter(d => 
        d.name.toLowerCase().includes(searchTerm) ||
        d.specialty.toLowerCase().includes(searchTerm)
      );

      if (filtered.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      
      empty.classList.add('hidden');
      container.innerHTML = filtered.map(d => `
        <div class="bg-white rounded-lg shadow p-3 border-r-4 border-blue-500">
          <div class="flex justify-between mb-2">
            <div>
              <h3 class="text-sm font-bold">ğŸ‘¨â€âš•ï¸ ${d.name}</h3>
              <p class="text-xs text-indigo-600">ğŸ©º ${d.specialty}</p>
              <p class="text-xs text-green-600">ğŸ“ ${d.area}</p>
            </div>
          </div>
          <div class="bg-gray-50 rounded p-2 mb-2 text-xs">
            <p>ğŸ“ ${d.phone}</p>
            ${d.address ? `<p>ğŸ¢ ${d.address}</p>` : ''}
          </div>
          <div class="flex gap-2">
            <button onclick="editDoctor('${d.id}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button onclick="deleteDoctor('${d.id}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded text-xs font-bold">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      `).join('');
    }

    // Render Visits
    function renderVisits() {
      const container = document.getElementById('visitsList');
      const empty = document.getElementById('emptyVisitsState');
      const searchTerm = document.getElementById('searchVisitInput').value.toLowerCase();
      
      let filtered = visits.filter(v => 
        v.doctorName.toLowerCase().includes(searchTerm)
      );

      if (filtered.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      
      empty.classList.add('hidden');
      
      const getBadge = (result) => {
        const badges = {
          prescribed: '<span class="badge badge-prescribed">ğŸ’Š Ø³ÙØ§Ø±Ø´</span>',
          rejected: '<span class="badge badge-rejected">âŒ Ø±Ø¯</span>',
          followup: '<span class="badge badge-followup">ğŸ”„ Ù…Ø¬Ø¯Ø¯</span>'
        };
        return badges[result] || '';
      };
      
      container.innerHTML = filtered.map(v => `
        <div class="bg-white rounded-lg shadow p-3 border-r-4 ${v.result === 'prescribed' ? 'border-green-500' : v.result === 'rejected' ? 'border-red-500' : 'border-orange-500'}">
          <div class="flex justify-between mb-2">
            <div>
              <div class="flex items-center gap-1 mb-1">
                <h3 class="text-sm font-bold">ğŸ‘¨â€âš•ï¸ ${v.doctorName}</h3>
                ${getBadge(v.result)}
              </div>
              <p class="text-xs text-gray-600">ğŸ“… ${formatDate(v.date)} - ${v.time}</p>
            </div>
          </div>
          ${v.notes ? `<div class="bg-gray-50 rounded p-2 mb-2 text-xs"><p>ğŸ“ ${v.notes}</p></div>` : ''}
          <div class="flex gap-2">
            <button onclick="editVisit('${v.id}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button onclick="deleteVisit('${v.id}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded text-xs font-bold">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      `).join('');
    }

    // Render Pharmacies
    function renderPharmacies() {
      const container = document.getElementById('pharmaciesList');
      const empty = document.getElementById('emptyPharmaciesState');
      const searchTerm = document.getElementById('searchPharmacyInput').value.toLowerCase();
      
      let filtered = pharmacies.filter(p => 
        p.name.toLowerCase().includes(searchTerm) ||
        p.pharmacist.toLowerCase().includes(searchTerm)
      );

      if (filtered.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      
      empty.classList.add('hidden');
      container.innerHTML = filtered.map(p => `
        <div class="bg-white rounded-lg shadow p-3 border-r-4 border-green-500">
          <div class="flex justify-between mb-2">
            <div>
              <h3 class="text-sm font-bold">ğŸ¥ ${p.name}</h3>
              <p class="text-xs text-purple-600">ğŸ’Š ${p.pharmacist}</p>
            </div>
          </div>
          <div class="bg-gray-50 rounded p-2 mb-2 text-xs">
            <p>ğŸ“ ${p.phone}</p>
            <p>ğŸ“ ${p.address}</p>
          </div>
          <div class="flex gap-2">
            <button onclick="editPharmacy('${p.id}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button onclick="deletePharmacy('${p.id}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded text-xs font-bold">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      `).join('');
    }

    // Render Orders
    function renderOrders() {
      const container = document.getElementById('ordersList');
      const empty = document.getElementById('emptyOrdersState');
      const searchTerm = document.getElementById('searchOrderInput').value.toLowerCase();
      
      let filtered = orders.filter(o => 
        o.pharmacyName.toLowerCase().includes(searchTerm) ||
        o.drug.toLowerCase().includes(searchTerm)
      );

      if (filtered.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      
      empty.classList.add('hidden');
      container.innerHTML = filtered.map(o => `
        <div class="bg-white rounded-lg shadow p-3 border-r-4 border-purple-500">
          <div class="flex justify-between mb-2">
            <div>
              <h3 class="text-sm font-bold">ğŸ¥ ${o.pharmacyName}</h3>
              <p class="text-xs text-blue-600">ğŸ’Š ${o.drug}</p>
              <p class="text-xs text-gray-600">ğŸ“… ${formatDate(o.date)}</p>
            </div>
          </div>
          <div class="bg-gray-50 rounded p-2 mb-2 text-xs">
            ${o.cartons > 0 ? `<p>ğŸ“¦ Ú©Ø§Ø±ØªÙ†: ${formatNumber(o.cartons)}</p>` : ''}
            ${o.units > 0 ? `<p>ğŸ”¢ Ø¹Ø¯Ø¯: ${formatNumber(o.units)}</p>` : ''}
            ${o.notes ? `<p>ğŸ“ ${o.notes}</p>` : ''}
          </div>
          <div class="flex gap-2">
            <button onclick="editOrder('${o.id}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button onclick="deleteOrder('${o.id}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded text-xs font-bold">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      `).join('');
    }

    // Render Sales
    function renderSales() {
      const container = document.getElementById('salesList');
      const empty = document.getElementById('emptySalesState');
      
      if (sales.length === 0) {
        container.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      
      empty.classList.add('hidden');
      const sorted = [...sales].sort((a, b) => new Date(b.week) - new Date(a.week));
      
      container.innerHTML = sorted.map(s => `
        <div class="bg-white rounded-lg shadow p-3 border-r-4 border-indigo-500">
          <div class="flex justify-between mb-2">
            <div>
              <h3 class="text-sm font-bold">ğŸ“Š Ù‡ÙØªÙ‡ ${s.week}</h3>
              <p class="text-base text-green-600 font-bold">${formatNumber(s.amount)} Ø¹Ø¯Ø¯ ÙØ±ÙˆØ´</p>
            </div>
          </div>
          ${s.notes ? `<div class="bg-gray-50 rounded p-2 mb-2 text-xs"><p>ğŸ“ ${s.notes}</p></div>` : ''}
          <div class="flex gap-2">
            <button onclick="editSales('${s.id}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button onclick="deleteSales('${s.id}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded text-xs font-bold">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      `).join('');
    }

    // Sales Chart
    function renderSalesChart() {
      const ctx = document.getElementById('salesChart');
      if (!ctx) return;
      
      if (salesChart) {
        salesChart.destroy();
      }
      
      const sorted = [...sales].sort((a, b) => new Date(a.week) - new Date(b.week));
      const labels = sorted.map(s => s.week);
      const data = sorted.map(s => s.amount);
      
      salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ØªØ¹Ø¯Ø§Ø¯ ÙØ±ÙˆØ´',
            data: data,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatNumber(value);
                }
              }
            }
          }
        }
      });
    }

    // Populate Selects
    function populateSelects() {
      const doctorSelect = document.getElementById('doctorSelect');
      doctorSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>' +
        doctors.map(d => `<option value="${d.id}">${d.name} - ${d.specialty}</option>`).join('');
      
      const pharmacySelect = document.getElementById('pharmacySelect');
      pharmacySelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>' +
        pharmacies.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }

    // Modal Handlers
    document.getElementById('closeDoctorModal').addEventListener('click', () => {
      document.getElementById('doctorModal').style.display = 'none';
      document.getElementById('doctorForm').reset();
    });

    document.getElementById('closeVisitModal').addEventListener('click', () => {
      document.getElementById('visitModal').style.display = 'none';
      document.getElementById('visitForm').reset();
    });

    document.getElementById('closePharmacyModal').addEventListener('click', () => {
      document.getElementById('pharmacyModal').style.display = 'none';
      document.getElementById('pharmacyForm').reset();
    });

    document.getElementById('closeOrderModal').addEventListener('click', () => {
      document.getElementById('orderModal').style.display = 'none';
      document.getElementById('orderForm').reset();
    });

    document.getElementById('closeSalesModal').addEventListener('click', () => {
      document.getElementById('salesModal').style.display = 'none';
      document.getElementById('salesForm').reset();
    });

    document.getElementById('cancelDoctorBtn').addEventListener('click', () => {
      document.getElementById('doctorModal').style.display = 'none';
    });

    document.getElementById('cancelVisitBtn').addEventListener('click', () => {
      document.getElementById('visitModal').style.display = 'none';
    });

    document.getElementById('cancelPharmacyBtn').addEventListener('click', () => {
      document.getElementById('pharmacyModal').style.display = 'none';
    });

    document.getElementById('cancelOrderBtn').addEventListener('click', () => {
      document.getElementById('orderModal').style.display = 'none';
    });

    document.getElementById('cancelSalesBtn').addEventListener('click', () => {
      document.getElementById('salesModal').style.display = 'none';
    });

    // Form Submissions
    document.getElementById('doctorForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const data = {
        id: editingId || `doctor_${Date.now()}`,
        name: document.getElementById('doctorNameInput').value.trim(),
        specialty: document.getElementById('specialtyInput').value.trim(),
        phone: document.getElementById('phoneInput').value.trim(),
        area: document.getElementById('areaInput').value.trim(),
        address: document.getElementById('addressInput').value.trim(),
        createdAt: new Date().toISOString()
      };
      
      if (editingId) {
        const index = doctors.findIndex(d => d.id === editingId);
        if (index !== -1) doctors[index] = data;
      } else {
        doctors.push(data);
      }
      
      saveData(STORAGE_KEYS.DOCTORS, doctors);
      renderAll();
      updateStats();
      document.getElementById('doctorModal').style.display = 'none';
      document.getElementById('doctorForm').reset();
      showToast('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
    });

    document.getElementById('visitForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const doctorId = document.getElementById('doctorSelect').value;
      const doctor = doctors.find(d => d.id === doctorId);
      
      const data = {
        id: editingId || `visit_${Date.now()}`,
        doctorId: doctorId,
        doctorName: doctor.name,
        date: document.getElementById('visitDate').value,
        time: document.getElementById('visitTime').value,
        result: document.getElementById('visitResult').value,
        notes: document.getElementById('visitNotes').value.trim(),
        createdAt: new Date().toISOString()
      };
      
      if (editingId) {
        const index = visits.findIndex(v => v.id === editingId);
        if (index !== -1) visits[index] = data;
      } else {
        visits.push(data);
      }
      
      saveData(STORAGE_KEYS.VISITS, visits);
      renderAll();
      updateStats();
      document.getElementById('visitModal').style.display = 'none';
      document.getElementById('visitForm').reset();
      showToast('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
    });

    document.getElementById('pharmacyForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const data = {
        id: editingId || `pharmacy_${Date.now()}`,
        name: document.getElementById('pharmacyNameInput').value.trim(),
        pharmacist: document.getElementById('pharmacistNameInput').value.trim(),
        phone: document.getElementById('pharmacyPhoneInput').value.trim(),
        address: document.getElementById('pharmacyAddressInput').value.trim(),
        createdAt: new Date().toISOString()
      };
      
      if (editingId) {
        const index = pharmacies.findIndex(p => p.id === editingId);
        if (index !== -1) pharmacies[index] = data;
      } else {
        pharmacies.push(data);
      }
      
      saveData(STORAGE_KEYS.PHARMACIES, pharmacies);
      renderAll();
      updateStats();
      document.getElementById('pharmacyModal').style.display = 'none';
      document.getElementById('pharmacyForm').reset();
      showToast('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
    });

    document.getElementById('orderForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const pharmacyId = document.getElementById('pharmacySelect').value;
      const pharmacy = pharmacies.find(p => p.id === pharmacyId);
      
      const data = {
        id: editingId || `order_${Date.now()}`,
        pharmacyId: pharmacyId,
        pharmacyName: pharmacy.name,
        date: document.getElementById('orderDate').value,
        drug: document.getElementById('drugName').value.trim(),
        cartons: parseInt(document.getElementById('cartonQty').value) || 0,
        units: parseInt(document.getElementById('unitQty').value) || 0,
        notes: document.getElementById('orderNotes').value.trim(),
        createdAt: new Date().toISOString()
      };
      
      if (editingId) {
        const index = orders.findIndex(o => o.id === editingId);
        if (index !== -1) orders[index] = data;
      } else {
        orders.push(data);
      }
      
      saveData(STORAGE_KEYS.ORDERS, orders);
      renderAll();
      updateStats();
      document.getElementById('orderModal').style.display = 'none';
      document.getElementById('orderForm').reset();
      showToast('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
    });

    document.getElementById('addSalesBtn').addEventListener('click', () => {
      editingId = null;
      document.getElementById('salesModal').style.display = 'flex';
    });

    document.getElementById('salesForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const data = {
        id: editingId || `sales_${Date.now()}`,
        week: document.getElementById('salesWeek').value,
        amount: parseFloat(document.getElementById('salesAmount').value),
        notes: document.getElementById('salesNotes').value.trim(),
        createdAt: new Date().toISOString()
      };
      
      if (editingId) {
        const index = sales.findIndex(s => s.id === editingId);
        if (index !== -1) sales[index] = data;
      } else {
        sales.push(data);
      }
      
      saveData(STORAGE_KEYS.SALES, sales);
      renderAll();
      renderSalesChart();
      document.getElementById('salesModal').style.display = 'none';
      document.getElementById('salesForm').reset();
      showToast('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
    });

    // Edit Functions
    window.editDoctor = function(id) {
      const item = doctors.find(d => d.id === id);
      if (!item) return;
      
      editingId = id;
      document.getElementById('doctorNameInput').value = item.name;
      document.getElementById('specialtyInput').value = item.specialty;
      document.getElementById('phoneInput').value = item.phone;
      document.getElementById('areaInput').value = item.area;
      document.getElementById('addressInput').value = item.address || '';
      document.getElementById('doctorModal').style.display = 'flex';
    };

    window.editVisit = function(id) {
      const item = visits.find(v => v.id === id);
      if (!item) return;
      
      editingId = id;
      document.getElementById('doctorSelect').value = item.doctorId;
      document.getElementById('visitDate').value = item.date;
      document.getElementById('visitTime').value = item.time;
      document.getElementById('visitResult').value = item.result;
      document.getElementById('visitNotes').value = item.notes || '';
      document.getElementById('visitModal').style.display = 'flex';
    };

    window.editPharmacy = function(id) {
      const item = pharmacies.find(p => p.id === id);
      if (!item) return;
      
      editingId = id;
      document.getElementById('pharmacyNameInput').value = item.name;
      document.getElementById('pharmacistNameInput').value = item.pharmacist;
      document.getElementById('pharmacyPhoneInput').value = item.phone;
      document.getElementById('pharmacyAddressInput').value = item.address;
      document.getElementById('pharmacyModal').style.display = 'flex';
    };

    window.editOrder = function(id) {
      const item = orders.find(o => o.id === id);
      if (!item) return;
      
      editingId = id;
      document.getElementById('pharmacySelect').value = item.pharmacyId;
      document.getElementById('orderDate').value = item.date;
      document.getElementById('drugName').value = item.drug;
      document.getElementById('cartonQty').value = item.cartons;
      document.getElementById('unitQty').value = item.units;
      document.getElementById('orderNotes').value = item.notes || '';
      document.getElementById('orderModal').style.display = 'flex';
    };

    window.editSales = function(id) {
      const item = sales.find(s => s.id === id);
      if (!item) return;
      
      editingId = id;
      document.getElementById('salesWeek').value = item.week;
      document.getElementById('salesAmount').value = item.amount;
      document.getElementById('salesNotes').value = item.notes || '';
      document.getElementById('salesModal').style.display = 'flex';
    };

    // Delete Functions
    window.deleteDoctor = function(id) {
      if (confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
        doctors = doctors.filter(d => d.id !== id);
        saveData(STORAGE_KEYS.DOCTORS, doctors);
        renderAll();
        updateStats();
        showToast('âœ… Ø­Ø°Ù Ø´Ø¯', 'success');
      }
    };

    window.deleteVisit = function(id) {
      if (confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
        visits = visits.filter(v => v.id !== id);
        saveData(STORAGE_KEYS.VISITS, visits);
        renderAll();
        updateStats();
        showToast('âœ… Ø­Ø°Ù Ø´Ø¯', 'success');
      }
    };

    window.deletePharmacy = function(id) {
      if (confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
        pharmacies = pharmacies.filter(p => p.id !== id);
        saveData(STORAGE_KEYS.PHARMACIES, pharmacies);
        renderAll();
        updateStats();
        showToast('âœ… Ø­Ø°Ù Ø´Ø¯', 'success');
      }
    };

    window.deleteOrder = function(id) {
      if (confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
        orders = orders.filter(o => o.id !== id);
        saveData(STORAGE_KEYS.ORDERS, orders);
        renderAll();
        updateStats();
        showToast('âœ… Ø­Ø°Ù Ø´Ø¯', 'success');
      }
    };

    window.deleteSales = function(id) {
      if (confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
        sales = sales.filter(s => s.id !== id);
        saveData(STORAGE_KEYS.SALES, sales);
        renderAll();
        renderSalesChart();
        showToast('âœ… Ø­Ø°Ù Ø´Ø¯', 'success');
      }
    };

    // PDF Generation
    document.getElementById('generatePDFBtn').addEventListener('click', async () => {
      const type = document.getElementById('reportType').value;
      const period = document.getElementById('reportPeriod').value;
      const fromDate = document.getElementById('reportFromDate').value;
      const toDate = document.getElementById('reportToDate').value;
      
      showToast('ï¿½ï¿½ï¿½ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ PDF...', 'success');
      
      setTimeout(() => {
        const reportContent = generateReportHTML(type, fromDate, toDate);
        const printWindow = window.open('', '', 'width=800,height=600');
        printWindow.document.write(reportContent);
        printWindow.document.close();
        printWindow.print();
        showToast('âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª', 'success');
      }, 500);
    });

    function generateReportHTML(type, fromDate, toDate) {
      let content = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
          <meta charset="UTF-8">
          <title>Ú¯Ø²Ø§Ø±Ø´ ${type === 'doctors' ? 'Ù¾Ø²Ø´Ú©Ø§Ù†' : type === 'pharmacies' ? 'Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡â€ŒÙ‡Ø§' : 'Ú©Ø§Ù…Ù„'}</title>
          <style>
            body { font-family: 'Tahoma', sans-serif; padding: 20px; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
            th { background: #667eea; color: white; }
            h1 { text-align: center; color: #667eea; }
            .header { text-align: center; margin-bottom: 20px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Ú¯Ø²Ø§Ø±Ø´ ${type === 'doctors' ? 'Ù¾Ø²Ø´Ú©Ø§Ù†' : type === 'pharmacies' ? 'Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡â€ŒÙ‡Ø§' : 'Ú©Ø§Ù…Ù„'}</h1>
            <p>Ø§Ø² ØªØ§Ø±ÛŒØ®: ${fromDate || 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'} ØªØ§ ${toDate || 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}</p>
            <p>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„ÛŒØ¯: ${new Date().toLocaleDateString('fa-IR')}</p>
          </div>
      `;
      
      if (type === 'doctors' || type === 'both') {
        let filtered = doctors;
        if (fromDate) filtered = filtered.filter(d => d.createdAt >= fromDate);
        if (toDate) filtered = filtered.filter(d => d.createdAt <= toDate);
        
        content += `
          <h2>Ù¾Ø²Ø´Ú©Ø§Ù† (${filtered.length} Ù†ÙØ±)</h2>
          <table>
            <thead>
              <tr>
                <th>Ø±Ø¯ÛŒÙ</th>
                <th>Ù†Ø§Ù…</th>
                <th>ØªØ®ØµØµ</th>
                <th>ØªÙ…Ø§Ø³</th>
                <th>Ù…Ù†Ø·Ù‚Ù‡</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map((d, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${d.name}</td>
                  <td>${d.specialty}</td>
                  <td>${d.phone}</td>
                  <td>${d.area}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
      
      if (type === 'pharmacies' || type === 'both') {
        let filtered = pharmacies;
        if (fromDate) filtered = filtered.filter(p => p.createdAt >= fromDate);
        if (toDate) filtered = filtered.filter(p => p.createdAt <= toDate);
        
        content += `
          <h2>Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡â€ŒÙ‡Ø§ (${filtered.length} Ù…ÙˆØ±Ø¯)</h2>
          <table>
            <thead>
              <tr>
                <th>Ø±Ø¯ÛŒÙ</th>
                <th>Ù†Ø§Ù… Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡</th>
                <th>Ø¯Ø§Ø±ÙˆØ³Ø§Ø²</th>
                <th>ØªÙ…Ø§Ø³</th>
                <th>Ø¢Ø¯Ø±Ø³</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map((p, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${p.name}</td>
                  <td>${p.pharmacist}</td>
                  <td>${p.phone}</td>
                  <td>${p.address}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
      
      content += `
        </body>
        </html>
      `;
      
      return content;
    }

    // Search Handlers
    document.getElementById('searchDoctorInput').addEventListener('input', renderDoctors);
    document.getElementById('searchVisitInput').addEventListener('input', renderVisits);
    document.getElementById('searchPharmacyInput').addEventListener('input', renderPharmacies);
    document.getElementById('searchOrderInput').addEventListener('input', renderOrders);

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-lg shadow-2xl z-50 fade-in font-bold text-sm`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 2500);
    }

    // Initialize
    loadData();
    
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('visitDate').value = today;
    document.getElementById('orderDate').value = today;
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a2b97f0a6c22d36',t:'MTc2Mzg0NzcxMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>